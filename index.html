<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>軒揚數理教師打卡系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-effect { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .punch-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .punch-btn:active { transform: scale(0.95); opacity: 0.9; }
        .gradient-bg { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
        
        @keyframes modalIn {
            0% { opacity: 0; transform: scale(0.9) translateY(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .animate-modal-in { animation: modalIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        button svg, button span { pointer-events: none; }
    </style>
</head>
<body class="gradient-bg min-h-screen text-slate-900">

    <!-- 狀態列 -->
    <nav class="fixed top-0 inset-x-0 z-40 px-6 py-6 flex justify-between items-center">
        <div class="flex items-center gap-2 glass-effect px-4 py-2 rounded-full border border-white shadow-sm">
            <div id="statusDot" class="w-2.5 h-2.5 rounded-full bg-slate-300"></div>
            <span id="statusText" class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">定位初始化...</span>
        </div>
        <button id="navAdminBtn" class="w-10 h-10 glass-effect rounded-full flex items-center justify-center text-slate-500 border border-white shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
        </button>
    </nav>

    <!-- 主打卡畫面 -->
    <main id="punchView" class="max-w-md mx-auto pt-28 pb-10 px-6 space-y-10">
        <div class="text-center space-y-1">
            <h1 class="text-5xl font-black tracking-tighter text-slate-800">軒揚數理</h1>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.4em]">教師打卡系統</p>
        </div>

        <div class="space-y-6">
            <div class="space-y-2 relative">
                <label class="px-4 text-[10px] font-black text-slate-400 tracking-widest uppercase">Teacher Name</label>
                <input id="teacherName" type="text" placeholder="輸入姓名" class="w-full glass-effect p-6 rounded-[2rem] text-xl font-bold border-2 border-transparent shadow-xl outline-none">
                <div id="nameError" class="hidden absolute left-5 -bottom-6 text-rose-500 text-xs font-bold">請輸入教師姓名</div>
            </div>

            <div class="space-y-2">
                <label class="px-4 text-[10px] font-black text-slate-400 tracking-widest uppercase">Location</label>
                <div class="flex gap-3">
                    <select id="locationSelect" class="flex-1 glass-effect p-6 rounded-[2rem] text-lg font-bold border border-white shadow-inner outline-none appearance-none bg-transparent"></select>
                    <button id="addLocBtn" class="w-16 h-16 bg-blue-600 text-white rounded-[1.8rem] flex items-center justify-center shadow-lg active:scale-90 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" /></svg>
                    </button>
                </div>
            </div>

            <div class="pt-4 space-y-4">
                <!-- 補打卡文字連結 -->
                <div class="text-center px-2">
                    <p class="text-sm font-bold text-slate-500">
                        如需補打卡，請洽 
                        <a href="https://lin.ee/3hsWVYs" target="_blank" class="text-blue-600 underline decoration-2 underline-offset-4">
                            「軒揚師培教育」官方帳號
                        </a>
                    </p>
                </div>

                <div class="grid grid-cols-1 gap-5">
                    <button id="punchInBtn" class="punch-btn bg-emerald-500 text-white p-10 rounded-[2.5rem] font-black text-2xl shadow-xl">上班打卡</button>
                    <button id="punchOutBtn" class="punch-btn bg-slate-900 text-white p-10 rounded-[2.5rem] font-black text-2xl shadow-xl">下班打卡</button>
                </div>
            </div>
        </div>
    </main>

    <!-- 管理端驗證 -->
    <section id="authView" class="hidden fixed inset-0 z-50 bg-white/95 backdrop-blur-md flex items-center justify-center p-8">
        <div class="w-full max-w-sm text-center">
            <h3 class="font-black text-2xl mb-8 uppercase tracking-widest text-slate-400">管理端驗證</h3>
            <div id="passwordSection" class="space-y-4">
                <input id="adminPassword" type="password" placeholder="輸入管理密碼" class="w-full p-5 bg-slate-100 rounded-2xl text-center text-xl font-bold border-2 border-transparent focus:border-blue-500 outline-none transition-all">
                <button id="verifyPwBtn" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-black">登入後台</button>
            </div>
            <div id="adminContent" class="hidden flex flex-col gap-4 mt-4">
                <p class="text-emerald-600 font-bold mb-2">驗證成功</p>
                <a id="sheetLink" href="https://docs.google.com/spreadsheets/d/1TW_qsvU_uN7N3K6sFDI-qkEqWvVK9ZIJGXCZbA6U668/edit?gid=0#gid=0" target="_blank" class="w-full py-5 bg-emerald-600 text-white rounded-2xl font-black shadow-lg text-center">開啟 Google 試算表</a>
                <button id="logoutBtn" class="w-full py-3 text-slate-400 text-sm font-bold">登出並關閉</button>
            </div>
            <button id="authBackBtn" class="mt-8 text-slate-400 font-bold">返回打卡頁面</button>
        </div>
    </section>

    <!-- 新增地點 Modal -->
    <div id="locModal" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-6 bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 text-center space-y-4 shadow-2xl animate-modal-in">
            <h3 class="text-xl font-black text-slate-800">新增打卡地點</h3>
            <input id="newLocInput" type="text" placeholder="輸入地點名稱" class="w-full p-4 bg-slate-50 rounded-xl border text-center font-bold outline-none">
            <div class="flex gap-2">
                <button id="closeLocBtn" class="flex-1 text-slate-400 font-bold">取消</button>
                <button id="confirmLocBtn" class="flex-1 py-4 bg-blue-600 text-white rounded-xl font-black">新增</button>
            </div>
        </div>
    </div>

    <!-- 成功與載入遮罩 (省略部分細節保持程式碼精簡) -->
    <div id="successOverlay" class="hidden fixed inset-0 z-[200] flex items-center justify-center px-8 bg-slate-900/60 backdrop-blur-md">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-10 text-center shadow-2xl">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 bg-emerald-100 text-emerald-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7" /></svg>
            </div>
            <h3 id="successTitle" class="text-3xl font-black text-slate-800 mb-2">打卡成功</h3>
            <p id="successTeacher" class="text-xl font-bold text-slate-600"></p>
        </div>
    </div>
    <div id="loadingOverlay" class="hidden fixed inset-0 z-[300] flex items-center justify-center bg-white/50 backdrop-blur-sm">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzBIUrIlNyOdNgJxccb2ov_WK2JNiyOoldj9t7jjvqPkQp9bZuQo39jE7r6o4OQjPQt/exec";
        const ADMIN_PASSWORD = "860201"; 
        
        const PRESET_LOCS = ['文星文理補習班（大社吉的堡）', '鳳翔文理補習班', '麥克亞綸文理補習班'];
        let activeLocs = JSON.parse(localStorage.getItem('sy_locs_v2')) || PRESET_LOCS;
        let currentGeo = null;

        const hide = (id) => document.getElementById(id).classList.add('hidden');
        const show = (id) => document.getElementById(id).classList.remove('hidden');

        function refreshLocUI(selectedValue = null) {
            const select = document.getElementById('locationSelect');
            select.innerHTML = activeLocs.map(l => `<option value="${l}">${l}</option>`).join('');
            if (selectedValue) select.value = selectedValue;
        }

        function showLoading(show) { document.getElementById('loadingOverlay').classList.toggle('hidden', !show); }

        function showFeedback(teacher, title) {
            const overlay = document.getElementById('successOverlay');
            document.getElementById('successTitle').innerText = title;
            document.getElementById('successTeacher').innerText = teacher + " G'Day, Fella!";
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.add('hidden'), 3000);
        }

        async function handlePunch(type) {
            const nameEl = document.getElementById('teacherName');
            const name = nameEl.value.trim();
            if (!name) { 
                nameEl.classList.add('border-rose-400'); 
                document.getElementById('nameError').classList.remove('hidden'); 
                return; 
            }
            document.getElementById('nameError').classList.add('hidden');
            nameEl.classList.remove('border-rose-400');

            showLoading(true);
            const payload = {
                teacher: name,
                location: document.getElementById('locationSelect').value,
                type: type,
                lat: currentGeo ? currentGeo.lat : "無定位",
                lng: currentGeo ? currentGeo.lng : "無定位",
                accuracy: currentGeo ? currentGeo.accuracy : "無定位"
            };

            try {
                await fetch(GAS_URL, {
                    method: 'POST', mode: 'no-cors', cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                showLoading(false);
                showFeedback(name, `${type}成功`);
                localStorage.setItem('sy_name_last', name);
            } catch (e) {
                showLoading(false);
                alert("傳送失敗：" + e.message);
            }
        }

        document.getElementById('verifyPwBtn').onclick = () => {
            const input = document.getElementById('adminPassword').value;
            if (input === ADMIN_PASSWORD) {
                hide('passwordSection'); show('adminContent');
            } else {
                alert("密碼錯誤！");
            }
        };

        document.getElementById('logoutBtn').onclick = () => {
            hide('adminContent'); show('passwordSection'); hide('authView');
        };

        document.getElementById('navAdminBtn').onclick = () => show('authView');
        document.getElementById('authBackBtn').onclick = () => hide('authView');
        document.getElementById('addLocBtn').onclick = () => show('locModal');
        document.getElementById('closeLocBtn').onclick = () => hide('locModal');
        
        document.getElementById('confirmLocBtn').onclick = () => {
            const val = document.getElementById('newLocInput').value.trim();
            if (val && !activeLocs.includes(val)) {
                activeLocs.push(val);
                localStorage.setItem('sy_locs_v2', JSON.stringify(activeLocs));
                refreshLocUI(val);
            }
            document.getElementById('newLocInput').value = "";
            hide('locModal');
        };

        document.getElementById('punchInBtn').onclick = () => handlePunch('上班打卡');
        document.getElementById('punchOutBtn').onclick = () => handlePunch('下班打卡');

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                currentGeo = { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: Math.round(pos.coords.accuracy) };
                document.getElementById('statusDot').className = "w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]";
                document.getElementById('statusText').innerText = `定位正常 (${currentGeo.accuracy}m)`;
            }, () => {
                document.getElementById('statusText').innerText = "定位失敗，請開啟GPS";
            }, { enableHighAccuracy: true });
        }

        refreshLocUI();
        const last = localStorage.getItem('sy_name_last');
        if (last) document.getElementById('teacherName').value = last;
    </script>
</body>
</html>
